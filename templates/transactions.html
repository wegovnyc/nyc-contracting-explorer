{% extends "base.html" %}

{% block content %}
<h2>Transactions (Since 2010)</h2>
<p class="text-muted">Transaction data from the Checkbook NYC.</p>

<form method="get" action="{{ url_for('transactions') }}" class="mb-4">
    <div class="input-group">
        <input type="text" name="q" class="form-control" placeholder="Search by Vendor, Agency, or Contract ID..."
            value="{{ search_query if search_query else '' }}">
        <div class="input-group-append">
            <select name="limit" class="custom-select" onchange="this.form.submit()">
                <option value="20" {% if limit==20 %}selected{% endif %}>20 per page</option>
                <option value="50" {% if limit==50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if limit==100 %}selected{% endif %}>100 per page</option>
            </select>
            <button class="btn btn-primary" type="submit">Search</button>
            {% if search_query %}
            <a href="{{ url_for('transactions') }}" class="btn btn-outline-secondary">Clear</a>
            {% endif %}
        </div>
    </div>
</form>



{% if show_dashboard %}
<div class="card mb-4">
    <div class="card-header">
        Spending Trend (Last 12 Months)
    </div>
    <div class="card-body">
        <canvas id="spendingChart" height="100"></canvas>
    </div>
</div>
{% else %}
<div class="mb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Transactions</h4>
        <span class="badge badge-secondary">{{ pagination_info.total if pagination_info else 'Results' }}</span>
    </div>
    <div class="table-responsive bg-white border rounded">
        <table class="table table-hover mb-0">
            <thead class="thead-light">
                <tr>
                    <th>Issue Date</th>
                    <th>Agency</th>
                    <th>Vendor</th>
                    <th>Contract ID</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    <td>{{ row['issue_date'] }}</td>
                    <td>{{ row['agency_name'] }}</td>
                    <td>
                        {% if row['vendor_name'] %}
                        <a href="/vendors?q={{ row['vendor_name'] }}" class="text-dark font-weight-bold">{{
                            row['vendor_name'] }}</a>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if row['contract_id'] %}
                        <a href="/contracts?q={{ row['contract_id'] }}">{{ row['contract_id'] }}</a>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ row['expense_category'] }}</td>
                    <td>${{ "{:,.2f}".format(row['check_amount']) }}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info view-transaction-btn"
                            data-issue-date="{{ row['issue_date'] }}" data-agency="{{ row['agency_name'] }}"
                            data-vendor="{{ row['vendor_name'] }}" data-contract-id="{{ row['contract_id'] }}"
                            data-amount="{{ row['check_amount'] }}" data-fiscal-year="{{ row['fiscal_year'] }}"
                            data-industry="{{ row['industry'] }}"
                            data-spending-category="{{ row['spending_category'] }}"
                            data-department="{{ row['department'] }}" data-budget-code="{{ row['budget_code'] }}"
                            data-expense-category="{{ row['expense_category'] }}"
                            data-sub-vendor="{{ row['sub_vendor'] }}"
                            data-prime-vendor="{{ row['associated_prime_vendor'] }}">View</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <nav aria-label="Spending pagination" class="mt-3">
        <ul class="pagination pagination-sm justify-content-center">
            {% if page > 1 %}
            <li class="page-item"><a class="page-link"
                    href="?page={{ page-1 }}&limit={{ limit }}{% if search_query %}&q={{ search_query }}{% endif %}">Previous</a>
            </li>
            {% else %}
            <li class="page-item disabled"><a class="page-link" href="#">Previous</a></li>
            {% endif %}

            <li class="page-item disabled"><a class="page-link" href="#">Page {{ page }}</a></li>

            {% if has_next %}
            <li class="page-item"><a class="page-link"
                    href="?page={{ page+1 }}&limit={{ limit }}{% if search_query %}&q={{ search_query }}{% endif %}">Next</a>
            </li>
            {% else %}
            <li class="page-item disabled"><a class="page-link" href="#">Next</a></li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" role="dialog" aria-labelledby="transactionModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Transaction Details</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <dl class="row">
                    <dt class="col-sm-4">Issue Date</dt>
                    <dd class="col-sm-8" id="modal-issue-date"></dd>

                    <dt class="col-sm-4">Agency</dt>
                    <dd class="col-sm-8" id="modal-agency"></dd>

                    <dt class="col-sm-4">Vendor</dt>
                    <dd class="col-sm-8" id="modal-vendor"></dd>

                    <dt class="col-sm-4">Amount</dt>
                    <dd class="col-sm-8" id="modal-amount"></dd>

                    <dt class="col-sm-4">Contract ID</dt>
                    <dd class="col-sm-8" id="modal-contract-id"></dd>

                    <hr class="w-100">

                    <dt class="col-sm-4">Fiscal Year</dt>
                    <dd class="col-sm-8" id="modal-fiscal-year"></dd>

                    <dt class="col-sm-4">Budget Code</dt>
                    <dd class="col-sm-8" id="modal-budget-code"></dd>

                    <dt class="col-sm-4">Department</dt>
                    <dd class="col-sm-8" id="modal-department"></dd>

                    <dt class="col-sm-4">Expense Category</dt>
                    <dd class="col-sm-8" id="modal-expense-category"></dd>

                    <dt class="col-sm-4">Spending Category</dt>
                    <dd class="col-sm-8" id="modal-spending-category"></dd>

                    <dt class="col-sm-4">Industry</dt>
                    <dd class="col-sm-8" id="modal-industry"></dd>

                    <hr class="w-100">

                    <dt class="col-sm-4">Sub Vendor</dt>
                    <dd class="col-sm-8" id="modal-sub-vendor"></dd>

                    <dt class="col-sm-4">Associated Prime Vendor</dt>
                    <dd class="col-sm-8" id="modal-prime-vendor"></dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        $('.view-transaction-btn').click(function () {
            var btn = $(this);

            $('#modal-issue-date').text(btn.data('issue-date'));
            $('#modal-agency').text(btn.data('agency'));
            $('#modal-vendor').text(btn.data('vendor'));

            var amount = parseFloat(btn.data('amount'));
            $('#modal-amount').text(amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' }));

            $('#modal-contract-id').text(btn.data('contract-id'));
            $('#modal-fiscal-year').text(btn.data('fiscal-year'));
            $('#modal-budget-code').text(btn.data('budget-code'));
            $('#modal-department').text(btn.data('department'));
            $('#modal-expense-category').text(btn.data('expense-category'));
            $('#modal-spending-category').text(btn.data('spending-category'));
            $('#modal-industry').text(btn.data('industry'));
            $('#modal-sub-vendor').text(btn.data('sub-vendor'));
            $('#modal-prime-vendor').text(btn.data('prime-vendor'));

            $('#transactionModal').modal('show');
        });

        // Initialize Charts if data exists or dashboard is active
        {% if show_dashboard %}
        const chartContainer = document.querySelector('.card-body');

        // Show loading state
        chartContainer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div><p class="mt-2 text-muted">Loading spending trends from Checkbook NYC...</p></div><canvas id="spendingChart" height="100" style="display:none;"></canvas>';

        fetch('/api/spending_stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    chartContainer.innerHTML = '<div class="alert alert-danger">' + data.error + '</div>';
                    return;
                }

                // Clear loader and show canvas
                chartContainer.innerHTML = '<canvas id="spendingChart" height="100"></canvas>';
                const ctx = document.getElementById('spendingChart').getContext('2d');

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Monthly Spending (Last 12 Months)',
                            data: data.series,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function (value, index, values) {
                                        return '$' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error fetching chart data:', error);
                chartContainer.innerHTML = '<div class="alert alert-danger">Error loading chart data</div>';
            });
        {% endif %}
    });
</script>
{% endblock %}